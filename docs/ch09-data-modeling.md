# ç¬¬ 9 ç« ï¼šæ•°æ®å»ºæ¨¡ä¸ IO è¾¹ç•Œ (Data Modeling)

> **"Truth is beauty, beauty truth."** > **â€œçœŸå³æ˜¯ç¾ï¼Œç¾å³æ˜¯çœŸã€‚â€**
> â€” _çº¦ç¿°Â·æµæ…ˆ (John Keats)_

---

è½¯ä»¶å¼€å‘ä¸­æœ€å¤§çš„æŒ‘æˆ˜å¾€å¾€ä¸åœ¨äºæ ¸å¿ƒé€»è¾‘ï¼Œè€Œåœ¨äº**è¾¹ç•Œ (Boundaries)**ã€‚å½“æ•°æ®ä»å¤–éƒ¨ä¸–ç•Œï¼ˆHTTP è¯·æ±‚ã€æ•°æ®åº“ã€æ–‡ä»¶ï¼‰æµå…¥ä½ çš„ç¨‹åºæ—¶ï¼Œå®ƒä»¬æ˜¯â€œè„â€çš„ã€æ— ç±»å‹çš„ã€‚

åœ¨ TypeScript ä¸­ï¼Œä½ å¯èƒ½ä¹ æƒ¯ç›´æ¥æŠŠ JSON `as` æˆä¸€ä¸ª Interfaceã€‚ä½†åœ¨ Python ä¸­ï¼Œå¤„ç†è¿™äº›æ•°æ®éœ€è¦æ›´æ˜ç¡®çš„ç­–ç•¥ã€‚æœ¬ç« æˆ‘ä»¬å°†æ¢è®¨ Python åŸç”Ÿçš„æ•°æ®å»ºæ¨¡å·¥å…·ï¼Œå¹¶æŒ‡å‡ºå®ƒä»¬çš„å±€é™æ€§ã€‚

## 9.1 IO è¾¹ç•Œçš„çœŸç›¸ï¼šç±»å‹è°è¨€

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæœ€å¸¸è§çš„åœºæ™¯ï¼šä» API è·å–ç”¨æˆ·æ•°æ®ã€‚

```python
import requests

class User:
    id: int
    name: str

def get_user(uid: int) -> User:
    resp = requests.get(f"/users/{uid}")
    data = resp.json() # è¿”å›çš„æ˜¯ dict (å­—å…¸)

    # âŒ å±é™©çš„æ“ä½œï¼šç±»å‹å¼ºè½¬
    # åœ¨ TS ä¸­ï¼Œä½ å¯èƒ½ä¼šå†™ï¼šreturn data as User
    # åœ¨ Python ä¸­ï¼Œè¿™è¡Œä»£ç è™½ç„¶é™æ€æ£€æŸ¥å¯èƒ½é€šè¿‡ï¼ˆå–å†³äºå†™æ³•ï¼‰ï¼Œ
    # ä½†è¿è¡Œæ—¶ data ä¾ç„¶æ˜¯ dictï¼Œæ ¹æœ¬ä¸æ˜¯ User ç±»çš„å®ä¾‹ï¼
    return data # type: ignore
```

å¦‚æœä½ å°è¯•è®¿é—® `user.name`ï¼š

- å¦‚æœ `user` æ˜¯å­—å…¸ï¼Œä½ å¿…é¡»ç”¨ `user["name"]`ã€‚
- å¦‚æœ `user` æ˜¯å¯¹è±¡ï¼Œä½ å¿…é¡»ç”¨ `user.name`ã€‚

**æ ¸å¿ƒç—›ç‚¹**ï¼šPython çš„ `dict` å’Œ `object` æ˜¯ä¸¤ç§å®Œå…¨ä¸åŒçš„å†…å­˜ç»“æ„ï¼Œä¸åƒ JS ä¸­ Object æ—¢æ˜¯å­—å…¸åˆæ˜¯å¯¹è±¡ã€‚

## 9.2 `TypedDict`ï¼šä¸ºå­—å…¸ç©¿ä¸Šå¤–è¡£

å¦‚æœä½ ä¸æƒ³æŠŠ JSON è½¬æ¢æˆç±»å®ä¾‹ï¼Œåªæ˜¯æƒ³è®© IDE çŸ¥é“å­—å…¸é‡Œæœ‰å“ªäº› Keyï¼Œå¯ä»¥ä½¿ç”¨ `TypedDict`ã€‚è¿™æœ€æ¥è¿‘ TS çš„ Interfaceã€‚

```python
from typing import TypedDict, NotRequired

# å®šä¹‰ä¸€ä¸ªå­—å…¸çš„"å½¢çŠ¶"
class UserDict(TypedDict):
    id: int
    name: str
    # Python 3.11+ æ”¯æŒ NotRequiredï¼Œç±»ä¼¼ TS çš„å¯é€‰å±æ€§ ?:
    email: NotRequired[str]

def process_user(u: UserDict) -> None:
    # âœ… IDE ç°åœ¨çŸ¥é“ u æœ‰ "id" å’Œ "name" é”®
    print(u["name"])

    # âŒ è®¿é—®ä¸å­˜åœ¨çš„é”®ï¼Œé™æ€æ£€æŸ¥ä¼šæŠ¥é”™
    # print(u["age"])

# è¿è¡Œæ—¶
data = {"id": 1, "name": "Alice"}
process_user(data) # âœ…
```

**å±€é™æ€§**ï¼š`TypedDict` ä»…ä»…æ˜¯ç»™é™æ€æ£€æŸ¥å·¥å…·çœ‹çš„ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ `dict`ï¼Œæ²¡æœ‰ä»»ä½•éªŒè¯é€»è¾‘ã€‚å¦‚æœä¼ å…¥çš„æ•°æ®ç¼ºäº† `id`ï¼Œè¿è¡Œæ—¶ç…§æ ·æŠ¥é”™ã€‚

### ğŸ“ TS å¼€å‘è€…ä¾¿ç­¾ï¼šInterface vs TypedDict

> - **TS Interface**: `interface User { id: number }`ã€‚
> - **Python TypedDict**: `class User(TypedDict): id: int`ã€‚
>
> å®ƒä»¬éå¸¸ç›¸ä¼¼ï¼šéƒ½åªå­˜åœ¨äºç¼–è¯‘/æ£€æŸ¥é˜¶æ®µï¼Œè¿è¡Œæ—¶éƒ½åªæ˜¯æ™®é€šçš„ JSON å¯¹è±¡/å­—å…¸ã€‚å®ƒæ˜¯å¤„ç†çº¯ JSON æ•°æ®æœ€è½»é‡çš„æ–¹å¼ã€‚

## 9.3 `Dataclasses`ï¼šåä¹‰åŒ–å¯¹è±¡

å½“ä½ éœ€è¦ç»™æ•°æ®ç»‘å®šè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ï¼Œæˆ–è€…éœ€è¦æ›´ä¸¥æ ¼çš„ç»“æ„æ—¶ï¼Œä½ åº”è¯¥ä½¿ç”¨ **Dataclasses**ã€‚å®ƒæ˜¯ Python 3.7+ çš„æ ‡å‡†åº“ï¼Œç”¨äºæ›¿ä»£æ‰‹å†™ç¹ççš„ `class`ã€‚

### 9.3.1 åŸºç¡€è¯­æ³•

```python
from dataclasses import dataclass, field

@dataclass
class User:
    id: int
    name: str
    # é»˜è®¤å€¼
    is_active: bool = True
    # âš ï¸ é™·é˜±ï¼šå¯å˜é»˜è®¤å€¼å¿…é¡»ç”¨ field(default_factory=...)
    tags: list[str] = field(default_factory=list)

u = User(id=1, name="Alice")
print(u) # User(id=1, name='Alice', is_active=True, tags=[])
```

Python è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆäº† `__init__`, `__repr__`, `__eq__` ç­‰æ–¹æ³•ã€‚

### 9.3.2 ä¸å¯å˜æ€§ï¼š`frozen=True`

```python
@dataclass(frozen=True)
class Config:
    host: str
    port: int

c = Config("localhost", 8080)
# c.port = 9090 # âŒ è¿è¡Œæ—¶æŠ¥é”™ï¼šFrozenInstanceError
```

è¿™ä¸ä»…æä¾›äº†ç±»ä¼¼ TS `readonly` çš„å®‰å…¨æ€§ï¼Œè¿˜è®©å¯¹è±¡å˜æˆäº†**å¯å“ˆå¸Œçš„ (Hashable)**ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä½œä¸ºå­—å…¸çš„ Keyã€‚

### 9.3.3 æ€§èƒ½ä¼˜åŒ–ï¼š`slots=True` (Python 3.10+)

```python
@dataclass(slots=True)
class Point:
    x: int
    y: int
```

é»˜è®¤çš„ Python å¯¹è±¡ä½¿ç”¨ `__dict__` å­—å…¸æ¥å­˜å‚¨å±æ€§ï¼Œè¿™å¾ˆçµæ´»ä½†è´¹å†…å­˜ã€‚`slots=True` ä¼šå‘Šè¯‰è§£é‡Šå™¨é¢„ç•™å›ºå®šçš„å†…å­˜ç©ºé—´ï¼Œ**å¤§å¹…é™ä½å†…å­˜å ç”¨å¹¶æå‡è®¿é—®é€Ÿåº¦**ã€‚å¯¹äºåˆ›å»ºæ•°ç™¾ä¸‡ä¸ªå°å¯¹è±¡çš„åœºæ™¯ï¼Œè¿™æ˜¯å¿…é€‰é¡¹ã€‚

## 9.4 è„æ•°æ®é˜²å¾¡ï¼šä¸ºä»€ä¹ˆ Dataclass è¿˜æ˜¯ä¸å¤Ÿï¼Ÿ

è¿™æ˜¯ **Type Boundaryï¼ˆç±»å‹è¾¹ç•Œï¼‰** æœ€å±é™©çš„åœ°æ–¹ã€‚

å‡è®¾å‰ç«¯ä¼ æ¥çš„ JSON æ˜¯è¿™æ ·çš„ï¼š

```json
{
  "id": "123", // æ³¨æ„ï¼šè¿™æ˜¯å­—ç¬¦ä¸²ï¼
  "name": "Alice"
}
```

å¦‚æœæˆ‘ä»¬å°è¯•ç”¨å®ƒåˆå§‹åŒ– Dataclassï¼š

```python
@dataclass
class User:
    id: int  # æˆ‘ä»¬å£°æ˜å®ƒæ˜¯ int
    name: str

raw_data = {"id": "123", "name": "Alice"}

# è§£åŒ…å­—å…¸è¿›è¡Œåˆå§‹åŒ–
user = User(**raw_data)

# ğŸ˜± ç¾éš¾å‘ç”Ÿï¼šç±»å‹ç³»ç»Ÿè¢«å‡»ç©¿äº†ï¼
print(user.id)        # è¾“å‡º "123" (å­—ç¬¦ä¸²)
print(type(user.id))  # <class 'str'>
```

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
Dataclass ç”Ÿæˆçš„ `__init__` æ–¹æ³•**åªæ˜¯ç®€å•çš„èµ‹å€¼**ï¼Œå®ƒ**ä¸ä¼š**æ£€æŸ¥ä½ ä¼ è¿›æ¥çš„å€¼æ˜¯å¦ç¬¦åˆç±»å‹æ³¨è§£ï¼Œä¹Ÿ**ä¸ä¼š**å¸®ä½ è‡ªåŠ¨è½¬æ¢ï¼ˆæ¯”å¦‚æŠŠ `"123"` è½¬æˆ `123`ï¼‰ã€‚

è¿™å°±å¯¼è‡´äº†â€œè„æ•°æ®â€æ±¡æŸ“äº†ä½ çš„å†…éƒ¨å¯¹è±¡ã€‚åç»­çš„ä»£ç å¦‚æœå‡è®¾ `user.id` æ˜¯ `int` å¹¶è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œå°±ä¼šåœ¨è¿œç¦»æ•°æ®æºçš„åœ°æ–¹çªç„¶å´©æºƒã€‚

### ğŸ“ TS å¼€å‘è€…ä¾¿ç­¾ï¼šè¿è¡Œæ—¶æ ¡éªŒçš„ç¼ºå¤±

> åœ¨ TS ä¸­ï¼Œ`const u = json as User` ä¹Ÿæ˜¯ä¸€ç§è°è¨€ã€‚ä½†é€šå¸¸æˆ‘ä»¬åœ¨ TS ä¸­ä½¿ç”¨ Zod / io-ts æ¥åœ¨è¾¹ç•Œå¤„æ¸…æ´—æ•°æ®ã€‚
>
> åœ¨ Python ä¸­ï¼š
>
> - **TypedDict**: çº¯é™æ€ï¼Œä¸ç®¡è¿è¡Œæ—¶ã€‚
> - **Dataclass**: è¿è¡Œæ—¶åªèµ‹å€¼ï¼Œä¸æ ¡éªŒï¼Œä¸è½¬æ¢ã€‚é€‚åˆ**å†…éƒ¨**æ•°æ®ä¼ é€’ï¼ˆä½ ä¿¡ä»»æ•°æ®çš„æ¥æºï¼‰ã€‚
> - **Pydantic** (ç¬¬ 17 ç« ): **è¿è¡Œæ—¶** æ ¡éªŒ + è½¬æ¢ã€‚é€‚åˆ**å¤–éƒ¨**æ•°æ®è¾“å…¥ï¼ˆAPI, DBï¼‰ã€‚

## 9.5 è½¬æ¢å±‚ï¼šå¦‚ä½•å®‰å…¨åœ°ä» Dict å˜ä¸º Object

æ—¢ç„¶ Dataclass é˜²ä¸ä½è„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨ä¸å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼ˆPydanticï¼‰çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

ä½ éœ€è¦ç¼–å†™æ˜ç¡®çš„**å·¥å‚æ–¹æ³•**æˆ–**è½¬æ¢å‡½æ•°**ã€‚

```python
from typing import Any

@dataclass
class User:
    id: int
    name: str

    @classmethod
    def from_dict(cls, data: dict[str, Any]) -> "User":
        # åœ¨è¿™é‡Œè¿›è¡Œæ‰‹åŠ¨çš„ç±»å‹æ ¡éªŒå’Œè½¬æ¢
        if not isinstance(data.get("id"), (str, int)):
             raise ValueError("Invalid id")

        # æ‰‹åŠ¨å¼ºè½¬ï¼Œç¡®ä¿è¿›å…¥æ¨¡å‹çš„æ•°æ®æ˜¯å¹²å‡€çš„
        return cls(
            id=int(data["id"]),
            name=str(data["name"])
        )

# å®‰å…¨ä½¿ç”¨
user = User.from_dict({"id": "123", "name": "Alice"})
# ç°åœ¨ user.id æ˜¯çœŸæ­£çš„ int(123)
```

è™½ç„¶å†™èµ·æ¥ç¹çï¼Œä½†è¿™æ‰æ˜¯è´Ÿè´£ä»»çš„å·¥ç¨‹ä»£ç ã€‚å®ƒåˆ’æ¸…äº†â€œè„æ•°æ®â€å’Œâ€œå‡€æ•°æ®â€çš„ç•Œé™ã€‚

---

**æœ¬ç« å°ç»“**

æ•°æ®å»ºæ¨¡æ˜¯ Python å·¥ç¨‹åŒ–çš„æ·±æ°´åŒºã€‚

1.  **IO è¾¹ç•Œ**: å¤–éƒ¨è¾“å…¥çš„ JSON æ°¸è¿œæ˜¯ `dict`ï¼Œç±»å‹æ³¨è§£åœ¨è¿™é‡Œæ˜¯å¤±æ•ˆçš„ã€‚
2.  **TypedDict**: é€‚ç”¨äºä¸éœ€è¦æ–¹æ³•çš„è½»é‡çº§å­—å…¸ç»“æ„ï¼Œç±»ä¼¼ TS Interfaceã€‚
3.  **Dataclass**: é€‚ç”¨äºç³»ç»Ÿå†…éƒ¨æµè½¬çš„å®ä½“å¯¹è±¡ï¼Œæ”¯æŒä¸å¯å˜ (`frozen`) å’Œæ€§èƒ½ä¼˜åŒ– (`slots`)ã€‚
4.  **é˜²å¾¡æ€ç»´**: Dataclass ä¸ä¼šè‡ªåŠ¨æ ¡éªŒç±»å‹ã€‚å¯¹äºä¸å¯ä¿¡çš„å¤–éƒ¨è¾“å…¥ï¼Œå¿…é¡»æ‰‹åŠ¨ç¼–å†™è½¬æ¢é€»è¾‘ï¼Œæˆ–è€…ç­‰å¾…æˆ‘ä»¬ç¬¬ 17 ç« ä»‹ç»çš„ç¥å™¨ â€”â€” **Pydantic**ã€‚

æ—¢ç„¶æˆ‘ä»¬å·²ç»å®šä¹‰å¥½äº†æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®ä¿æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™äº›æ•°æ®æ—¶ï¼Œç±»å‹åˆ¤æ–­æ˜¯å®Œå¤‡çš„ï¼Ÿæ¯”å¦‚ï¼Œæˆ‘æ€ä¹ˆç¡®ä¿æˆ‘å¤„ç†äº† `Status` æšä¸¾çš„æ‰€æœ‰å¯èƒ½æƒ…å†µï¼Ÿ

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†æ·±å…¥ **åè®® (Protocols)**ï¼Œè¿™æ˜¯ Python ç±»å‹ç³»ç»Ÿä¸­å¤„ç†â€œå¤šæ€â€çš„å…³é”®ï¼Œä¹Ÿæ˜¯è¿æ¥é™æ€ç±»å‹ä¸åŠ¨æ€ç‰¹æ€§çš„æ¡¥æ¢ã€‚

> **æ€è€ƒé¢˜**ï¼š
> `Dataclass` å’Œ `TypedDict` åœ¨ JSON åºåˆ—åŒ–æ—¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
> å¦‚æœæˆ‘ç›´æ¥ç”¨ `json.dumps(my_dataclass_instance)` ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼ˆæç¤ºï¼šPython çš„æ ‡å‡† `json` åº“é»˜è®¤ä¸è®¤è¯† Dataclassï¼Œä½ éœ€è¦ `dataclasses.asdict` å¸®å¿™ï¼‰ã€‚
